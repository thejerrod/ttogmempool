#include <TFT_eSPI.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

#define BUTTON_1 37  // Button 1 pin
#define BUTTON_2 38  // Button 2 pin

// Initialize the TFT display
TFT_eSPI tft = TFT_eSPI();

// Color scheme
#define BACKGROUND_COLOR TFT_BLACK
#define TEXT_COLOR TFT_WHITE
#define ACCENT_COLOR TFT_CYAN

// API URLs
const char* mempool_api_url = "https://mempool.space/api/v1/fees/recommended";
const char* lightning_api_url = "https://mempool.space/api/v1/lightning/statistics/latest";
const char* block_height_api_url = "https://mempool.space/api/blocks/tip/height";

// Default suggested fees
int fastestFee = 0;
int halfHourFee = 0;
int hourFee = 0;

// Lightning network statistics
int channel_count = 0;
int node_count = 0;
int total_capacity = 0;
int med_fee_rate = 0;

// Current block height
int current_block = 0;

// Button variables
int button1State;
int button2State;
unsigned long lastButtonPress = 0;
int currentDisplay = 0;
int maxDisplay = 4;

void setup() {
  Serial.begin(115200);

  // Initialize the TFT display
  tft.init();
  tft.setRotation(1);
  tft.fillScreen(BACKGROUND_COLOR);
  tft.setTextSize(2);
  tft.setTextColor(TEXT_COLOR);
  
  // Initialize the buttons
  pinMode(BUTTON_1, INPUT_PULLUP);
  pinMode(BUTTON_2, INPUT_PULLUP);
}

void loop() {
  // Get the current time
  unsigned long currentTime = millis();

  // Check if button 1 was pressed
  button1State = digitalRead(BUTTON_1);
  if (button1State == LOW && currentTime - lastButtonPress > 500) {
    currentDisplay--;
    if (currentDisplay < 0) {
      currentDisplay = maxDisplay;
    }
    lastButtonPress = currentTime;
  }

  // Check if button 2 was pressed
  button2State = digitalRead(BUTTON_2);
  if (button2State == LOW && currentTime - lastButtonPress > 500) {
    currentDisplay++;
    if (currentDisplay > maxDisplay) {
      currentDisplay = 0;
    }
    lastButtonPress = currentTime;
  }

  // Display the current page
  switch (currentDisplay) {
    case 0:
      // Display the suggested fees on the TFT display using the TFT_eSPI library
      displaySuggestedFees();
      break;

    case 1:
      // Display the lightning network statistics on the TFT display using the TFT_eSPI library
      displayLightningStats();
      break;

    case 2:
      // Display the current block height on the TFT display using the TFT_eSPI library
      displayBlockHeight();
      break;

    case 3:
      // Display the current halving info **im not sure if this working
      displayHalvingInfo();
      break;
  }
}

void displaySuggestedFees() {
  // Clear the screen
  tft.fillScreen(BACKGROUND_COLOR);

  // Send the API request
  HTTPClient http;
  http.begin(mempool_api_url);
  int httpCode = http.GET();

  // If the request was successful, parse the JSON response
  if (httpCode == HTTP_CODE_OK) {
    String jsonStr = http.getString();
    DynamicJsonDocument doc(1024);
    deserializeJson(doc, jsonStr);

    fastestFee = doc["fastestFeerate"];
    halfHourFee = doc["halfHourFeerate"];
    hourFee = doc["hourFeerate"];

    // Display the suggested fees on the TFT display
    tft.setCursor(0, 0);
    tft.print("Suggested Fees (sats/vB)\n");
    tft.setTextColor(ACCENT_COLOR);
    tft.print("Fastest: ");
    tft.setTextColor(TEXT_COLOR);
    tft.print(fastestFee);
    tft.print(" sats/vB");
    tft.print("\nHalf Hour: ");
    tft.setTextColor(TEXT_COLOR);
    tft.print(halfHourFee);
    tft.print(" sats/vB");
    tft.print("\nHour: ");
    tft.setTextColor(TEXT_COLOR);
    tft.print(hourFee);
    tft.print(" sats/vB");

    // Display a graph of the suggested fees
    int graphWidth = 200;
    int graphHeight = 100;
    int graphX = (tft.width() - graphWidth) / 2;
    int graphY = tft.height() - graphHeight - 20;
    tft.drawRect(graphX, graphY, graphWidth, graphHeight, ACCENT_COLOR);
    int fastestBarHeight = map(fastestFee, 0, 300, 0, graphHeight);
    int halfHourBarHeight = map(halfHourFee, 0, 300, 0, graphHeight);
    int hourBarHeight = map(hourFee, 0, 300, 0, graphHeight);
    tft.fillRect(graphX + 10, graphY + graphHeight - fastestBarHeight, 20, fastestBarHeight, FASTEST_COLOR);
    tft.fillRect(graphX + 70, graphY + graphHeight - halfHourBarHeight, 20, halfHourBarHeight, HALF_HOUR_COLOR);
    tft.fillRect(graphX + 130, graphY + graphHeight - hourBarHeight, 20, hourBarHeight, HOUR_COLOR);
  } else {
    // If the request failed, display an error message on the TFT display
    tft.setCursor(0, 0);
    tft.print("Error: Failed to retrieve suggested fees.");
  }

  // End the HTTP connection
  http.end();
}


void displayLightningStats() {
  // Clear the screen
  tft.fillScreen(BACKGROUND_COLOR);

  // Send the API request
  HTTPClient http;
  http.begin(lightning_api_url);
  int httpCode = http.GET();

  if (httpCode > 0) {
    // Parse the JSON response
    String payload = http.getString();
    const size_t capacity = JSON_OBJECT_SIZE(4) + 70;
    StaticJsonDocument<capacity> doc;
    DeserializationError error = deserializeJson(doc, payload);

    // If parsing the JSON was successful
    if (!error) {
      // Extract the relevant information from the JSON response
      channel_count = doc["channels"];
      node_count = doc["nodes"];
      total_capacity = doc["total_capacity"];
      med_fee_rate = doc["median_fee_sat_per_byte"];

      // Display the Lightning Network statistics on the TFT display
      tft.setCursor(0, 0);
      tft.println("Lightning Network Statistics");
      tft.setTextColor(ACCENT_COLOR);
      tft.println("_______________________________");
      tft.setTextColor(TEXT_COLOR);
      tft.print("Channels: ");
      tft.print(channel_count);
      tft.println();
      tft.print("Nodes: ");
      tft.print(node_count);
      tft.println();
      tft.print("Total Capacity: ");
      tft.print(total_capacity);
      tft.println(" sats");
      tft.print("Median Fee Rate: ");
      tft.print(med_fee_rate);
      tft.println(" sats/byte");
      tft.setTextColor(ACCENT_COLOR);
      tft.println("_______________________________");
      tft.setTextColor(TEXT_COLOR);
      tft.println(" ");
      tft.println("Lightning Network Activity");
      tft.setTextColor(ACCENT_COLOR);
      tft.println("_______________________________");
      tft.setTextColor(TEXT_COLOR);
      tft.print("Channels Opened: ");
      tft.print(doc["channel_opens"]);
      tft.println();
      tft.print("Channels Closed: ");
      tft.print(doc["channel_closes"]);
      tft.println();
      tft.print("Successful Payments: ");
      tft.print(doc["num_payments"]);
      tft.println();
      tft.print("Failed Payments: ");
      tft.print(doc["num_failed_payments"]);
      tft.println();
      tft.setTextColor(ACCENT_COLOR);
      tft.println("_______________________________");
    } else {
      // If parsing the JSON failed, display an error message
      tft.println("Error: Failed to parse JSON response");
    }
  } else {
    // If the API request failed, display an error message
    tft.println("Error: Failed to retrieve Lightning Network statistics");
  }

  // Clean up
  http.end();
}
void displayBlockHeight() {
  // Clear the screen
  tft.fillScreen(BACKGROUND_COLOR);

  // Send the API request
  HTTPClient http;
  http.begin(block_height_api_url);
  int httpCode = http.GET();

  // Check if the request was successful
  if (httpCode == 200) {
    // Parse the JSON response
    String response = http.getString();
    DynamicJsonDocument doc(1024);
    deserializeJson(doc, response);
    
    // Get the current block height from the response
    current_block = doc["height"];

    // Display the current block height and some additional information on the TFT display
    tft.setCursor(0, 0);
    tft.println("Current Block Height");
    tft.println();
    tft.print("Block Height: ");
    tft.println(current_block);
    tft.print("Blocks Until Halving: ");
    tft.println(blocks_until_halving);
    tft.print("Time Until Halving: ");
    tft.println(time_until_halving);
  }
  else {
    // Display an error message on the TFT display
    tft.setCursor(0, 50);
    tft.println("Error: Unable to retrieve block height");
  }

  // End the HTTP connection
  http.end();
}
void displayHalvingInfo() {
  // Clear the screen
  tft.fillScreen(BACKGROUND_COLOR);

  // Send the API requests to get the current block height and block count
  HTTPClient http;
  http.begin(block_height_api_url);
  int httpCode = http.GET();

  // Check if the request was successful
  if (httpCode == HTTP_CODE_OK) {
    // Parse the JSON response
    String response = http.getString();
    DynamicJsonDocument doc(1024);
    deserializeJson(doc, response);
    
    // Get the current block height and total block count from the response
    current_block = doc["height"];
    total_blocks = doc["best_height"];

    // Calculate the blocks remaining until the next halving event
    int blocks_until_halving = HALVING_INTERVAL - (current_block % HALVING_INTERVAL);
    // Calculate the estimated time remaining until the next halving event
    int time_until_halving = blocks_until_halving * AVERAGE_BLOCK_TIME;

    // Display the halving information on the TFT display
    tft.setCursor(0, 0);
    tft.setTextColor(ACCENT_COLOR);
    tft.println("Bitcoin Halving Information");
    tft.println();

    tft.setTextColor(TEXT_COLOR);
    tft.print("Current Block Height: ");
    tft.println(current_block);
    tft.print("Total Blocks: ");
    tft.println(total_blocks);
    tft.print("Blocks Until Halving: ");
    tft.println(blocks_until_halving);
    tft.print("Estimated Time Until Halving: ");
    tft.print(time_until_halving / 60);
    tft.print(" minutes (");
    tft.print(time_until_halving / (60 * 24));
    tft.print(" days)");
    tft.println();

    // Draw a progress bar to show the progress towards the next halving
    int progress = (current_block % HALVING_INTERVAL) * 100 / HALVING_INTERVAL;
    tft.fillRect(10, 120, 220, 10, BACKGROUND_COLOR);
    tft.fillRect(10, 120, 220 * progress / 100, 10, ACCENT_COLOR);
    tft.drawRect(10, 120, 220, 10, TEXT_COLOR);
    tft.setCursor(10, 130);
    tft.print("Next Halving: ");
    tft.print(blocks_until_halving);
    tft.print(" blocks (");
    tft.print(progress);
    tft.print("%)");
  }
  else {
    // Display an error message on the TFT display
    tft.setCursor(0, 0);
    tft.setTextColor(ACCENT_COLOR);
    tft.println("Error: Unable to retrieve block height");
  }

  // End the HTTP connection
  http.end();
}
